# 1. 计算机系统概述

## 1.1 信息就是位（bits）+上下文（context--进程切换）

8bits=1字节，ASC11码表示文本字符，实际上就是用一个单字节（8bits）整数表示一个文本字符，这种表示方式说明了一种思想：系统中所有的信息---包括**磁盘文件**,**内存中的程序**，用户**上传的数据**，**网络中传输的数据**。而区别不同数据对象的方式就是数据对象的上下文，一个同样的字节序列可能表示一个整数，浮点，字符，或者机器指令。实际的整数值和机器表示方式会有很大的不同，是真值的近似值

~~~c++
//hello.c
//这串代码贯穿整本书的
#include<stdio.h>
int main(){
    printf("hello,world\n");
    return 0;
}
~~~



## 1.2 程序就是用其他程序翻译成不同的格式

在Unix系统上GCC编译器读取hello.c文件直到编译成可执行文件（exe)需要4步。需要执行4个阶段的程序分别是

| 预处理器(cpp)              | 编译器（ccl）        | 汇编器(as)          | 连接器(ld)                              |
| :------------------------- | -------------------- | ------------------- | --------------------------------------- |
| hello.c编译成hello.i(文本) | hello.i编译成hello.s | hello.s编译成二进制 | hello.o可重定位目标程序（没理解这句话） |

- **预处理阶段**

  会处理#include<stdio.h>代码将其直接插入当前文本中（代码中）

- **编译阶段**

  会翻译成汇编语言程序

  ~~~
  mian:
  	subq $8,%rep
  	movl $.LC0,%edi
  	call puts
  	movl $0,%eax
  	addq $8,%rsp
  	ret
  汇编语言非常有用，有用到什么程度？书里没讲
  ~~~

- **汇编阶段**

  将.s文件编译成二进制机器指令

- **链接阶段**

  printf函数是预先编译好了的目标文件（二进制），我需要以某种方式将他合并进来LD(连接器)就是干这件事的

## 1.3 了解编译系统的工作很有帮助

- **能优化程序性能**

  我们无需为了写出高效代码而去了解编译器的内部工作。但是我让编译器编译高效的代码（拿来用就行，无需了解内部工作，没到火候强行上会受伤），为什么switch语句高效？一个函数调用开销大，while比for效率高吗？等到第五章揭晓答案

- **了解连接时出现的错误**

  为什么连接器报告说无法解析引用？静态变量和局部变量有什么区别等等一系列问题等到第七章揭晓答案

- **避免安全漏洞**

  缓冲出溢出是造成大多数网络和服务器安全漏洞的主要原因，很少有程序员能限制从不信任的访问源接受的数据格式和数量，后面用编译器和操作系统可以降低攻击威胁

## 1.4 处理器读并解释内存中的指令

以shell为例子，执行

~~~
linux> ./hello
hello , world
linux>
~~~

读取文件并执行

### 1.4.1 系统的硬件组成

- **总线**

  贯穿整个系统的一组电子管称为总线，负责在各个部件间传递数据传送固定长的字节块和字节数

- **I/O设备**

  io是系统与外界连接的通道，每个io设备通过一个**适配器**和**控制器**与I/O设备相连（他俩主要区别是封装方式），控制器是IO设备本身，或者系统的主印制电路板（通常叫做主板）,适配器是一块插在主板槽的卡

![1586427520557](E:\note_book_of_computer_science\深入理解计算机系统\1586427520557.png)

具体详情会在第十章讲述

- **主存(平时说的内存)**

  一种临时存储设备，存放程序和处理的数据。在物理角度是一组动态随机存取存储器(**DRAM**),on logical  存储器是一个线性的字节数组，每个字节都有唯一的地址(从零开始)

- **处理器**

  解释存在主存中的指令的引擎，处理器的核心是大小为一个字的存储设备(寄存器)，称为程序计数器，并且总是指向内存的指令，**处理器看上去是按照一个非常简单的执行模型在执行**，其实这个模型就是**指令集（非常重要的东西）**，执行一条指令是执行一系列的步骤，且执行的指令不是相邻的。

  - **加载**：从主存中复制一个字节（8bits）或者一个字到寄存器，覆盖原来的内容
  - **存储**：从寄存器复制一个字节或者一个字到主存 的某个位置，覆盖原来的位置
  - **操作**：从寄存器中拿两个值复制到ALU当冲进行计算将结果放进寄存器覆盖原来的值
  - **跳转**：从指令中拿出一个字（8bits）复制到程序计数器覆盖原来的值

  现代处理器讲**指令集**和**微体系结构**区分开来（1.） 指令集执行每条机器代码（2.）微体系结构才是描述处理器实际执行流程

### 1.4.2 运行hello程序

以shell运行程序为例

1. **处理器**一行行的将源码读入主存（利用**直接存取器存取（DMA）** 直接将源码从硬盘读到主存）接着执行main（）函数。
2. 将数据从主存复制到寄存器文件
3. 将数据输出

## 1.5 高速缓存的重要性

高速存储设备造价贵，低速存储设备造假便宜，处理器从寄存器中读取数据要比从主存中读取数据快100倍。为了解决这个问题，提出了**高速缓存存储器**作为暂时存储区域

- L1高速缓存可达到几万字节与寄存器文件同速度
- L2高速缓存通过主线连接寄存器（**L1L2叫做静态随机访问存储器**，L2要比L1快5倍）
- L3高速缓存

程序员利用好高速缓存存储器能将程序性能提升一个数量级，这些将在第六章讲述

## 1.6 存储设备

处理器--->高速缓存--->大型设备

下图是存储器的层次结构

![1586431916260](E:\note_book_of_computer_science\深入理解计算机系统\1586431916260.png)

## 1.7 操作系统管理硬件

|应用程序|
|---|
|操作系统|
|处理器，主存，I/O设备|

![1586438539957](E:\note_book_of_computer_science\深入理解计算机系统\1586438539957.png)



### 1.7.1 进程

进程是操作系统对一个正在运行的程序的一种抽象

操作系统保持追踪进程运行所有所需的状态信息叫**上下文**

### 1.7.2 线程

开辟一个线程所需要资源比开辟一个进程的所需资源要少

，且是操作系统调度的基本单位

### 1.7.3 虚拟内存

|内核虚拟内存(用户代码不可见的内存)|
|:-:|
|用户栈运行时创建|
|共享库的内存映射区域|
|运行时（有malloc开辟）|
|读写的数据(从hello中加载的)|
|（程序开始的地方）只读的代码和数据(从hello中加载的)|

- **程序代码和数据**

  相对所有进程代码是从某一具体位置开始的，紧接着是全局数据,代码和数据去，直接按照可执行文件内容初始化

- **堆**

  运行开辟的数据，参考java的堆

- **共享库**

  这个地方书没细讲，的那是我的理解是第三方编译好的文件

- **栈**

  编译器用他来实现函数的调用，用户占在

- **内核虚拟内存**

  该部分区域为内核保留，不允许应用程序调用内核代码，硬件和操作系统精密复杂的交互

### 1.7.4 文件

文件就是字节序列，每个I/O，包括磁盘，键盘，显示器，甚至是网络都可以看做文件

## 1.8 系统之间利用网络通信

现在操作系统通过网络将各个系统连接在一起 ，我也可以使用telnet来连接远程服务器。执行远程调用

A主机有hello.c程序，用B主机执行hello代码，然后B可以远程调用并得到hello ,world 显示

## 1.9 重要内容

### 1.9.1  安达尔定律

最后总结一句话就是系统整体性提升一个level，需要大部分子系统性能都提升，无法通过局部提升获得整体性能的提升

### 1.9.2 并发和并行

- **线程级并发**

  一个操作系统控制多个处理器叫多核处理系统，现在操作系统存在**多核处理器**和**超线程**(同时多线程)的出现,CPU的核集成在电路芯片上，

![1586437241608](E:\note_book_of_computer_science\深入理解计算机系统\1586437241608.png)

典型多核处理器组织结构，

1. **超线程(同时多线程)**：

允许一个CPU执行多个控制流的技术，一个CPU有多个程序计数器和寄存器，而其他的硬件只有一个，例如ALU

2. **多核处理器从两方面提高系统性能**：
   - 不是模拟并发（单用户时间片轮训）执行程序
   - 多处理器一起执行，一核一个线程



- **指令集并行**

  现在处理器同时执行多条指令的属性称为**指令级并行**，早期是3-10个时钟周期执行一条指令，现在的是2-4个周期，如果处理器可以达到一个周期一个指令叫**超标零**

- **单指令，多数并行**

  现在处理器拥有特殊的硬件，允许一条指令产生多个可以 并行执行的操作，这种方式叫---**单指令**，**多数据**及**SIMD**,AMD提供SIMD堆float数据做加法处理

### 1.9.3 计算机系统中抽象的重要性

​	抽象是计算机科学中一种重要的概念之一（应该是养成这种抽象思维很重要，自己理解）

![1586439006600](E:\note_book_of_computer_science\深入理解计算机系统\1586439006600.png)



## 1.10 小结很重要

1. **程序就是一种文本格式**

2. **四个阶段编译**成exe文件

3. 计算机花费大量时间在硬盘-主存-寄存器间来回复制，故引入**存储器分层模型**

4. **DRAM** 不经过处理器直接将数据从硬盘加载到主存

5. **文件**：“io设备”

   **虚拟内存**：“io设备+主存”

   **进程**：“处理器+主存+io设备”

   **虚拟机**：“操作系统+处理器+主存+io设备”

